# Product Requirements Document: Mimo Smart Lab

## 1. 핵심 워크플로우 (User Journey)

### 1.1 개선된 프로세스 개요 (v2: Multi-Date Support)
실제 임상 환경에서는 한 번의 혈액검사에 **여러 장의 문서**(CBC, Chemistry, 특수 검사 등)가 발급되는 경우가 많고, 사용자는 **서로 다른 날짜의 검사들**을 한 번에 정리하고 싶어합니다. v2는 여러 날짜의 검사를 동시에 업로드하고 자동으로 그룹화하는 기능을 제공합니다.

1. **다중 파일 및 다중 날짜 업로드 (Multi-Document & Multi-Date Upload)**:
   - 사용자가 **여러 날짜의 검사 문서**를 모두 선택하여 한 번에 업로드할 수 있다.
   - 예: 2025-12-02 CBC.pdf + 2025-12-02 Chemistry.jpg + 2025-12-08 cPL.pdf = 서로 다른 날짜도 OK
   - 드래그앤드롭 또는 다중 파일 선택으로 최대 10개 파일까지 지원
   - **핵심**: 같은 날짜든 다른 날짜든 제약 없이 업로드 가능

2. **AI 일괄 분석 및 날짜별 자동 그룹화 (Batch AI Parsing & Auto-Grouping)**:
   - GPT-4o Vision API가 업로드된 모든 파일을 **병렬 처리**하여 `항목명`, `결과값`, `단위`, `참고치(Min-Max)`, **검사 날짜**, **병원명**을 추출한다.
   - 추출 완료 후 **검사 날짜 + 병원명** 기준으로 자동 그룹화
   - 같은 날짜에 여러 병원에서 검사한 경우 순번 부여 (1, 2, 3...)

3. **결과 우선 확인 with 날짜별 탭 (Preview Results First with Date Tabs)**:
   - **중요**: 매칭 프로세스를 거치기 **전에** 먼저 OCR 추출 결과를 보여준다.
   - **날짜별 탭 UI**: 각 날짜 그룹마다 독립적인 탭으로 표시
   - 탭 제목 예: "2025-12-08 (타임즈동물의료센터)" 또는 "2025-12-08 (타임즈동물의료센터) (2)"
   - 사용자가 각 탭에서 OCR 결과를 확인하고 수정할 수 있다.

4. **날짜 그룹별 AI 매핑 (Date-Group Based Smart Mapping)**:
   - **기존 방식**: 단순 문자열 매칭 (`CREA` -> `item_mappings` 테이블 조회)
   - **v2 방식**: 각 날짜 그룹의 OCR 결과를 독립적으로 AI 매칭 (병렬 처리)
   - GPT-4o가 DB의 `standard_items` 목록과 OCR 결과를 비교하여 **휴리스틱 매칭**을 제안
   - 예: OCR 결과가 `Creatine`(오타)이어도 AI가 문맥상 `Creatinine`일 확률이 높다고 판단
   - 매칭 신뢰도를 함께 표시: 🟢 높음(90% 이상) / 🟡 보통(70-90%) / 🔴 낮음(70% 미만)

5. **통합 검수 및 불일치 확인 (Unified Review & Resolve Discrepancies)**:
   - 모든 날짜 그룹의 AI 매칭 결과를 **하나의 테이블**로 통합 표시
   - **불일치 항목 우선 표시**: 매칭 신뢰도가 낮거나 매칭 실패한 항목을 상단에 배치
   - 사용자 액션:
     - ✅ AI 제안 승인
     - ✏️ 수동으로 다른 표준 항목 선택
     - ➕ 완전히 새로운 표준 항목 생성
     - 🔢 참고치 수정 (OCR 오인식 보정)

6. **날짜 그룹별 독립 저장 (Date-Group Independent Save)**:
   - 사용자가 [모두 저장]을 누르면 **각 날짜 그룹마다** 별도의 `test_records` + `test_results`를 생성한다.
   - 예: 2025-12-02 검사 → test_record #1, 2025-12-08 검사 → test_record #2
   - 각 그룹은 독립적인 트랜잭션으로 저장 (한 그룹 실패가 다른 그룹에 영향 없음)
   - 저장 완료 후 대시보드로 자동 이동하여 새로 추가된 모든 날짜의 데이터를 바로 확인할 수 있다.

## 2. 주요 기능 명세

### 2.1 다중 파일 업로드 인터페이스 (v2: Multi-Date Support)
- **드래그앤드롭 영역**: 여러 파일을 한 번에 드롭할 수 있는 넓은 업로드 존 제공
- **파일 목록 미리보기**: 업로드된 파일들을 썸네일과 함께 나열 (개별 삭제 가능)
- **메타데이터 자동 추출**: 각 파일에서 독립적으로 검사일자와 병원명을 추출
- **날짜별 자동 그룹화**: OCR 완료 후 검사 날짜 기준으로 자동 분류
- **일괄 분석 진행률**: "파일 1/3 분석 중..." 형태의 프로그레스바 표시
- **날짜별 탭 생성**: 추출된 날짜마다 독립적인 탭 UI 자동 생성

### 2.2 AI 기반 지능형 매핑
- **컨텍스트 인식 매핑**: GPT-4o에게 다음 정보를 함께 전달
  - DB의 전체 `standard_items` 목록 (name, display_name_ko, category)
  - OCR 추출 결과 (raw_name, value, unit)
  - 기존 `item_mappings` 테이블의 매칭 히스토리
- **매칭 신뢰도 점수**: AI가 각 매칭에 대해 0-100% 신뢰도 점수를 반환
- **배치 학습**: 사용자가 수동으로 매칭을 수정하면, 해당 매핑을 `item_mappings`에 저장하여 다음번에 자동 적용

### 2.3 동적 데이터 병합 (Merge Logic - v2: Date-Based Grouping)
- **스프레드시트 뷰**: 미모의 기존 엑셀 파일[Source 259]처럼, 가로축은 `날짜(검사차수)`, 세로축은 `검사 항목`인 피벗 테이블(Pivot Table)을 제공해야 한다.
- **누적 기록**: 새로운 날짜의 검사 결과가 추가되면, 기존 표의 오른쪽에 새 열(Column)이 추가되는 형태여야 한다.
- **다중 문서 통합**: 같은 날짜 + 같은 병원의 여러 문서에서 추출된 결과들이 하나의 열로 병합되어 표시된다.
- **날짜별 독립 컬럼**: 각 날짜 그룹은 독립적인 열(Column)로 표시
  - 예: "2025-12-08 (병원A)", "2025-12-08 (병원B) (2)", "2025-12-15 (병원A)"
- **같은 날짜 다중 병원**: 같은 날짜에 여러 병원에서 검사한 경우 순번 표시 (1, 2, ...)

### 2.4 시각화 및 알림
- **추세선 그래프**: `cPL`이나 `BUN/Creatinine` 같은 주요 항목은 클릭 시 시계열 꺾은선 그래프를 모달로 띄워준다.
- **이상 수치 하이라이트**: `High`/`Low` 상태인 셀은 배경색을 붉은색/파란색으로 칠해 직관적으로 보이게 한다.

### 2.5 장비별 참고치 관리 (Multi-Equipment Reference Ranges)
**핵심**: 같은 검사 항목이라도 장비마다 참고치가 다르므로, 각 결과마다 독립적인 참고치를 저장하고 표시해야 한다.

**장비별 참고치 차이 예시**:
- Hitachi 장비 Creatinine 참고치: 0~10 mg/dL
- IDEXX 장비 Creatinine 참고치: 0~<9 mg/dL (9 미만)
- Fuji 장비 Creatinine 참고치: 0.5~1.8 mg/dL

**피벗 테이블에서의 표시**:
- **항목명 헤더**: 각 항목명(예: Creatinine) 아래에 작은 회색 글씨로 "여러 참고치 적용됨" 표시
  ```
  Creatinine (크레아티닌)
  여러 참고치 적용됨
  ```
- **Tooltip(마우스 오버) 상세 정보**: 각 데이터 셀에 마우스를 올리면 풍선 팝업으로 표시
  ```
  [Creatinine 크레아티닌]
  검사일: 2025-01-15
  결과값: 1.2 mg/dL
  참고치: 0.5-1.8 (Hitachi)
  상태: Normal ✓
  ```
- **참고치 변경 경고**: 이전 검사와 참고치가 바뀐 경우 ⚠️ 아이콘 표시
  - Tooltip에 추가 메시지: "참고치 변경됨 (이전: 0-10, 현재: 0.5-1.8)"
  - 이유: 장비 교체, 검사 방법 변경 등을 사용자가 인지할 수 있도록

**시계열 그래프에서의 처리**:
- 참고치 범위가 검사마다 다를 수 있으므로, 그래프에 **여러 개의 참고치 밴드**를 표시
- 또는 가장 최근 검사의 참고치를 기본으로 표시하고, 참고치 변경 지점에 수직선 표시
- 범례에 "참고치: 검사마다 상이함" 명시

## 3. 화면별 상세 명세

### 3.1 업로드 페이지 (/upload)
**목표**: 여러 파일을 한 번에 업로드하고 일괄 분석 시작

**UI 구성**:
- 📤 **파일 드롭존**: 점선 테두리의 드래그앤드롭 영역 (최대 10개 파일, 각 10MB 이하)
- 📋 **업로드된 파일 목록**:
  - 각 파일별 썸네일, 파일명, 크기 표시
  - ❌ 개별 삭제 버튼
- 🔍 **메타데이터 미리보기**: 첫 번째 파일에서 추출한 검사일자/병원명 표시
- ▶️ **[일괄 분석 시작]** 버튼: 모든 파일을 GPT-4o에 전송

### 3.2 결과 확인 페이지 (/preview)
**목표**: OCR 추출 결과를 매핑 전에 먼저 확인하고 수정

**UI 구성**:
- 📊 **원본 데이터 테이블**:
  ```
  | 항목명(OCR)    | 결과값 | 단위  | 참고치(Min-Max) | 출처 파일      |
  |---------------|-------|------|----------------|---------------|
  | Creatine      | 1.2   | mg/dL| 0.5-1.8        | chemistry.pdf |
  | WBC           | 8.5   | 10^3 | 5.0-16.0       | cbc.jpg       |
  ```
- ✏️ **인라인 수정**: 각 셀을 클릭하여 즉시 수정 가능
- ➡️ **[다음: AI 매칭 시작]** 버튼

### 3.3 매핑 확인 페이지 (/staging)
**목표**: AI가 제안한 매핑을 검수하고 불일치 항목 해결

**UI 구성**:
- 🎯 **매칭 결과 테이블**:
  ```
  | OCR 항목명 | AI 제안 표준 항목    | 신뢰도 | 결과값 | 상태      | 액션          |
  |-----------|-------------------|--------|-------|----------|--------------|
  | Creatine  | Creatinine (크레아티닌) | 🟢 95% | 1.2   | Normal   | [승인] [수정] |
  | vLIP      | (매칭 실패)          | 🔴 N/A | 450   | Unknown  | [선택▼] [신규+] |
  | WBC       | White Blood Cell  | 🟢 100%| 8.5   | Normal   | [승인]       |
  ```
- 🔴 **불일치 항목 필터**: 신뢰도 낮은 항목만 보기
- 📝 **드롭다운 선택기**: 표준 항목 수동 선택 (카테고리별 그룹화)
- ➕ **신규 항목 생성 모달**:
  - 표준 항목명 (영문)
  - 한글 표시명
  - 카테고리 (CBC/Chemistry/Special 등)
  - 기본 단위
- 💾 **[모두 저장]** 버튼: 확정 후 DB 저장

### 3.4 대시보드 페이지 (/dashboard)
**목표**: 저장된 모든 검사 결과를 피벗 테이블로 시각화

**UI 구성**: (기존과 동일하되, 다중 문서에서 온 데이터가 하나의 날짜 열로 통합됨)

## 4. UI 레퍼런스
- 미모의 기존 PDF 자료[Source 259]와 동일한 레이아웃을 웹으로 구현하되, 모바일에서도 볼 수 있도록 반응형 테이블(가로 스크롤 허용)로 제작한다.
- **다중 파일 업로드**: Dropzone.js 또는 react-dropzone 라이브러리 활용
- **매칭 신뢰도 시각화**: 프로그레스바 또는 색상 코드(녹색/노란색/빨간색)로 직관적 표시
