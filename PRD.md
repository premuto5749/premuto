# Product Requirements Document: Mimo Smart Lab

## 1. 핵심 워크플로우 (User Journey)

### 1.1 개선된 프로세스 개요
실제 임상 환경에서는 한 번의 혈액검사에 **여러 장의 문서**(CBC, Chemistry, 특수 검사 등)가 발급되는 경우가 많습니다. 기존의 단일 파일 업로드 방식은 매번 처음부터 다시 시작해야 하는 비효율이 있었습니다. 개선된 워크플로우는 다음과 같습니다:

1. **다중 파일 업로드 (Multi-Document Upload)**:
   - 사용자가 **한 번의 검사에 해당하는 모든 문서**를 동시에 업로드한다.
   - 예: CBC 결과지 1장 + Chemistry 결과지 1장 + cPL 특수검사 1장 = 총 3개 파일을 한 번에 선택
   - 드래그앤드롭 또는 다중 파일 선택으로 최대 10개 파일까지 지원

2. **AI 일괄 분석 (Batch AI Parsing)**:
   - GPT-4o Vision API가 업로드된 모든 파일을 **병렬 처리**하여 `항목명`, `결과값`, `단위`, `참고치(Min-Max)`를 추출한다.
   - 각 파일에서 추출된 검사 날짜, 병원명이 일치하는지 자동 검증한다.

3. **결과 우선 확인 (Preview Results First)**:
   - **중요**: 매칭 프로세스를 거치기 **전에** 먼저 OCR 추출 결과를 보여준다.
   - 사용자가 "AI가 이 정도로 읽었구나"를 먼저 확인할 수 있다.
   - 이 단계에서 OCR 오류(숫자 인식 실패 등)를 빠르게 발견하고 수정할 수 있다.

4. **AI 기반 지능형 매핑 (Smart Mapping with AI)**:
   - **기존 방식**: 단순 문자열 매칭 (`CREA` -> `item_mappings` 테이블 조회)
   - **개선 방식**: GPT-4o가 DB의 `standard_items` 목록과 OCR 결과를 비교하여 **휴리스틱 매칭**을 제안한다.
   - 예: OCR 결과가 `Creatine`(오타)이어도 AI가 문맥상 `Creatinine`일 확률이 높다고 판단
   - 매칭 신뢰도를 함께 표시: 🟢 높음(90% 이상) / 🟡 보통(70-90%) / 🔴 낮음(70% 미만)

5. **검수 및 불일치 확인 (Review & Resolve Discrepancies)**:
   - AI가 제안한 매칭 결과를 **테이블 형태**로 보여준다.
   - **불일치 항목 우선 표시**: 매칭 신뢰도가 낮거나 매칭 실패한 항목을 상단에 배치
   - 사용자 액션:
     - ✅ AI 제안 승인
     - ✏️ 수동으로 다른 표준 항목 선택
     - ➕ 완전히 새로운 표준 항목 생성
     - 🔢 참고치 수정 (OCR 오인식 보정)

6. **일괄 저장 (Batch Save)**:
   - 사용자가 [모두 저장]을 누르면 **하나의 트랜잭션**으로 `test_records` 1개 + 다수의 `test_results`를 생성한다.
   - 저장 완료 후 대시보드로 자동 이동하여 새로 추가된 데이터를 바로 확인할 수 있다.

## 2. 주요 기능 명세

### 2.1 다중 파일 업로드 인터페이스
- **드래그앤드롭 영역**: 여러 파일을 한 번에 드롭할 수 있는 넓은 업로드 존 제공
- **파일 목록 미리보기**: 업로드된 파일들을 썸네일과 함께 나열 (개별 삭제 가능)
- **메타데이터 자동 추출**: 첫 번째 파일에서 검사일자와 병원명을 추출하여 나머지 파일과 비교
- **일괄 분석 진행률**: "파일 1/3 분석 중..." 형태의 프로그레스바 표시

### 2.2 AI 기반 지능형 매핑
- **컨텍스트 인식 매핑**: GPT-4o에게 다음 정보를 함께 전달
  - DB의 전체 `standard_items` 목록 (name, display_name_ko, category)
  - OCR 추출 결과 (raw_name, value, unit)
  - 기존 `item_mappings` 테이블의 매칭 히스토리
- **매칭 신뢰도 점수**: AI가 각 매칭에 대해 0-100% 신뢰도 점수를 반환
- **배치 학습**: 사용자가 수동으로 매칭을 수정하면, 해당 매핑을 `item_mappings`에 저장하여 다음번에 자동 적용

### 2.3 동적 데이터 병합 (Merge Logic)
- **스프레드시트 뷰**: 미모의 기존 엑셀 파일[Source 259]처럼, 가로축은 `날짜(검사차수)`, 세로축은 `검사 항목`인 피벗 테이블(Pivot Table)을 제공해야 한다.
- **누적 기록**: 새로운 날짜의 검사 결과가 추가되면, 기존 표의 오른쪽에 새 열(Column)이 추가되는 형태여야 한다.
- **다중 문서 통합**: 같은 날짜에 여러 문서에서 추출된 결과들이 하나의 열로 병합되어 표시된다.

### 2.4 시각화 및 알림
- **추세선 그래프**: `cPL`이나 `BUN/Creatinine` 같은 주요 항목은 클릭 시 시계열 꺾은선 그래프를 모달로 띄워준다.
- **이상 수치 하이라이트**: `High`/`Low` 상태인 셀은 배경색을 붉은색/파란색으로 칠해 직관적으로 보이게 한다.

## 3. 화면별 상세 명세

### 3.1 업로드 페이지 (/upload)
**목표**: 여러 파일을 한 번에 업로드하고 일괄 분석 시작

**UI 구성**:
- 📤 **파일 드롭존**: 점선 테두리의 드래그앤드롭 영역 (최대 10개 파일, 각 10MB 이하)
- 📋 **업로드된 파일 목록**:
  - 각 파일별 썸네일, 파일명, 크기 표시
  - ❌ 개별 삭제 버튼
- 🔍 **메타데이터 미리보기**: 첫 번째 파일에서 추출한 검사일자/병원명 표시
- ▶️ **[일괄 분석 시작]** 버튼: 모든 파일을 GPT-4o에 전송

### 3.2 결과 확인 페이지 (/preview)
**목표**: OCR 추출 결과를 매핑 전에 먼저 확인하고 수정

**UI 구성**:
- 📊 **원본 데이터 테이블**:
  ```
  | 항목명(OCR)    | 결과값 | 단위  | 참고치(Min-Max) | 출처 파일      |
  |---------------|-------|------|----------------|---------------|
  | Creatine      | 1.2   | mg/dL| 0.5-1.8        | chemistry.pdf |
  | WBC           | 8.5   | 10^3 | 5.0-16.0       | cbc.jpg       |
  ```
- ✏️ **인라인 수정**: 각 셀을 클릭하여 즉시 수정 가능
- ➡️ **[다음: AI 매칭 시작]** 버튼

### 3.3 매핑 확인 페이지 (/staging)
**목표**: AI가 제안한 매핑을 검수하고 불일치 항목 해결

**UI 구성**:
- 🎯 **매칭 결과 테이블**:
  ```
  | OCR 항목명 | AI 제안 표준 항목    | 신뢰도 | 결과값 | 상태      | 액션          |
  |-----------|-------------------|--------|-------|----------|--------------|
  | Creatine  | Creatinine (크레아티닌) | 🟢 95% | 1.2   | Normal   | [승인] [수정] |
  | vLIP      | (매칭 실패)          | 🔴 N/A | 450   | Unknown  | [선택▼] [신규+] |
  | WBC       | White Blood Cell  | 🟢 100%| 8.5   | Normal   | [승인]       |
  ```
- 🔴 **불일치 항목 필터**: 신뢰도 낮은 항목만 보기
- 📝 **드롭다운 선택기**: 표준 항목 수동 선택 (카테고리별 그룹화)
- ➕ **신규 항목 생성 모달**:
  - 표준 항목명 (영문)
  - 한글 표시명
  - 카테고리 (CBC/Chemistry/Special 등)
  - 기본 단위
- 💾 **[모두 저장]** 버튼: 확정 후 DB 저장

### 3.4 대시보드 페이지 (/dashboard)
**목표**: 저장된 모든 검사 결과를 피벗 테이블로 시각화

**UI 구성**: (기존과 동일하되, 다중 문서에서 온 데이터가 하나의 날짜 열로 통합됨)

## 4. UI 레퍼런스
- 미모의 기존 PDF 자료[Source 259]와 동일한 레이아웃을 웹으로 구현하되, 모바일에서도 볼 수 있도록 반응형 테이블(가로 스크롤 허용)로 제작한다.
- **다중 파일 업로드**: Dropzone.js 또는 react-dropzone 라이브러리 활용
- **매칭 신뢰도 시각화**: 프로그레스바 또는 색상 코드(녹색/노란색/빨간색)로 직관적 표시
