# Product Requirements Document: Mimo Smart Lab

**버전 이력**:
- v3.2: 검사항목 마스터 데이터 v3, 표준항목 관리 페이지, 대시보드 View 옵션
- v3.1: 일일 기록 수정/내보내기, 검사 기록 병합
- v3.0: 일일 건강 기록 기능 추가
- v2.0: 다중 파일 업로드, AI 기반 매핑

---

## 0. 일일 건강 기록 워크플로우 (Daily Log - v3.1 업데이트)

### 0.1 일일 기록 프로세스
반려동물의 일상 건강 상태를 빠르게 기록하고 추적합니다.

1. **빠른 기록 입력**:
   - 우측 하단 + 버튼 클릭 → 카테고리 선택 (식사, 음수, 약, 배변, 배뇨, 호흡수)
   - 양 입력이 필요한 카테고리: 식사(g), 음수(ml), 호흡수(회/분), 약(정)
   - 원터치 카테고리: 배변, 배뇨 (클릭만으로 기록)

2. **타임라인 확인 및 수정** (v3.1 추가):
   - 기록 항목 클릭 → 상세 모달 표시
   - 수정 버튼 클릭 → 인라인 편집 모드
   - 수정 가능 항목: 양, 약 이름, 메모
   - 수정 불가 항목: 시간, 사진

3. **날짜 탐색**:
   - 헤더의 날짜 클릭 → 캘린더 팝오버
   - 이전/다음 버튼으로 날짜 이동
   - "오늘로 이동" 버튼 (과거 날짜 조회 시 표시)

4. **클립보드 내보내기** (v3.1 추가):
   - 헤더의 📋 버튼 클릭
   - 오늘 요약 + 상세 기록을 포맷팅하여 클립보드에 복사
   - 카카오톡, 메모 앱 등에 붙여넣기 가능

### 0.2 내보내기 포맷 예시
```
📋 2026년 1월 31일 금요일 기록

📊 오늘 요약
🍚 식사: 150g (2회)
💧 음수: 300ml (3회)
💊 약: 2회
💩 배변: 1회
🚽 배뇨: 3회
🫁 호흡수: 평균 24회/분 (2회 측정)

📝 상세 기록
08:30 | 🍚 식사 75g
09:00 | 💊 약 1정 (심장약)
10:15 | 💧 음수 100ml
...
```

---

## 1. 핵심 워크플로우 (User Journey)

### 1.1 개선된 프로세스 개요 (v2: Multi-Date Support)
실제 임상 환경에서는 한 번의 혈액검사에 **여러 장의 문서**(CBC, Chemistry, 특수 검사 등)가 발급되는 경우가 많고, 사용자는 **서로 다른 날짜의 검사들**을 한 번에 정리하고 싶어합니다. v2는 여러 날짜의 검사를 동시에 업로드하고 자동으로 그룹화하는 기능을 제공합니다.

1. **다중 파일 및 다중 날짜 업로드 (Multi-Document & Multi-Date Upload)**:
   - 사용자가 **여러 날짜의 검사 문서**를 모두 선택하여 한 번에 업로드할 수 있다.
   - 예: 2025-12-02 CBC.pdf + 2025-12-02 Chemistry.jpg + 2025-12-08 cPL.pdf = 서로 다른 날짜도 OK
   - 드래그앤드롭 또는 다중 파일 선택으로 최대 10개 파일까지 지원
   - **핵심**: 같은 날짜든 다른 날짜든 제약 없이 업로드 가능

2. **AI 일괄 분석 및 날짜별 자동 그룹화 (Batch AI Parsing & Auto-Grouping)**:
   - GPT-4o Vision API가 업로드된 모든 파일을 **병렬 처리**하여 `항목명`, `결과값`, `단위`, `참고치(Min-Max)`, **검사 날짜**, **병원명**을 추출한다.
   - 추출 완료 후 **검사 날짜 + 병원명** 기준으로 자동 그룹화
   - 같은 날짜에 여러 병원에서 검사한 경우 순번 부여 (1, 2, 3...)

3. **결과 우선 확인 with 날짜별 탭 (Preview Results First with Date Tabs)**:
   - **중요**: 매칭 프로세스를 거치기 **전에** 먼저 OCR 추출 결과를 보여준다.
   - **날짜별 탭 UI**: 각 날짜 그룹마다 독립적인 탭으로 표시
   - 탭 제목 예: "2025-12-08 (타임즈동물의료센터)" 또는 "2025-12-08 (타임즈동물의료센터) (2)"
   - 사용자가 각 탭에서 OCR 결과를 확인하고 수정할 수 있다.

4. **날짜 그룹별 AI 매핑 (Date-Group Based Smart Mapping)**:
   - **기존 방식**: 단순 문자열 매칭 (`CREA` -> `item_mappings` 테이블 조회)
   - **v2 방식**: 각 날짜 그룹의 OCR 결과를 독립적으로 AI 매칭 (병렬 처리)
   - GPT-4o가 DB의 `standard_items` 목록과 OCR 결과를 비교하여 **휴리스틱 매칭**을 제안
   - 예: OCR 결과가 `Creatine`(오타)이어도 AI가 문맥상 `Creatinine`일 확률이 높다고 판단
   - 매칭 신뢰도를 함께 표시: 🟢 높음(90% 이상) / 🟡 보통(70-90%) / 🔴 낮음(70% 미만)

5. **통합 검수 및 불일치 확인 (Unified Review & Resolve Discrepancies)**:
   - 모든 날짜 그룹의 AI 매칭 결과를 **하나의 테이블**로 통합 표시
   - **불일치 항목 우선 표시**: 매칭 신뢰도가 낮거나 매칭 실패한 항목을 상단에 배치
   - 사용자 액션:
     - ✅ AI 제안 승인
     - ✏️ 수동으로 다른 표준 항목 선택
     - ➕ 완전히 새로운 표준 항목 생성
     - 🔢 참고치 수정 (OCR 오인식 보정)

6. **날짜 그룹별 독립 저장 (Date-Group Independent Save)**:
   - 사용자가 [모두 저장]을 누르면 **각 날짜 그룹마다** 별도의 `test_records` + `test_results`를 생성한다.
   - 예: 2025-12-02 검사 → test_record #1, 2025-12-08 검사 → test_record #2
   - 각 그룹은 독립적인 트랜잭션으로 저장 (한 그룹 실패가 다른 그룹에 영향 없음)
   - 저장 완료 후 대시보드로 자동 이동하여 새로 추가된 모든 날짜의 데이터를 바로 확인할 수 있다.

## 2. 주요 기능 명세

### 2.1 다중 파일 업로드 인터페이스 (v2: Multi-Date Support)
- **드래그앤드롭 영역**: 여러 파일을 한 번에 드롭할 수 있는 넓은 업로드 존 제공
- **파일 목록 미리보기**: 업로드된 파일들을 썸네일과 함께 나열 (개별 삭제 가능)
- **메타데이터 자동 추출**: 각 파일에서 독립적으로 검사일자와 병원명을 추출
- **날짜별 자동 그룹화**: OCR 완료 후 검사 날짜 기준으로 자동 분류
- **일괄 분석 진행률**: "파일 1/3 분석 중..." 형태의 프로그레스바 표시
- **날짜별 탭 생성**: 추출된 날짜마다 독립적인 탭 UI 자동 생성

### 2.2 AI 기반 지능형 매핑
- **컨텍스트 인식 매핑**: GPT-4o에게 다음 정보를 함께 전달
  - DB의 전체 `standard_items` 목록 (name, display_name_ko, category)
  - OCR 추출 결과 (raw_name, value, unit)
  - 기존 `item_mappings` 테이블의 매칭 히스토리
- **매칭 신뢰도 점수**: AI가 각 매칭에 대해 0-100% 신뢰도 점수를 반환
- **배치 학습**: 사용자가 수동으로 매칭을 수정하면, 해당 매핑을 `item_mappings`에 저장하여 다음번에 자동 적용

### 2.3 동적 데이터 병합 (Merge Logic - v2: Date-Based Grouping)
- **스프레드시트 뷰**: 미모의 기존 엑셀 파일[Source 259]처럼, 가로축은 `날짜(검사차수)`, 세로축은 `검사 항목`인 피벗 테이블(Pivot Table)을 제공해야 한다.
- **누적 기록**: 새로운 날짜의 검사 결과가 추가되면, 기존 표의 오른쪽에 새 열(Column)이 추가되는 형태여야 한다.
- **다중 문서 통합**: 같은 날짜 + 같은 병원의 여러 문서에서 추출된 결과들이 하나의 열로 병합되어 표시된다.
- **날짜별 독립 컬럼**: 각 날짜 그룹은 독립적인 열(Column)로 표시
  - 예: "2025-12-08 (병원A)", "2025-12-08 (병원B) (2)", "2025-12-15 (병원A)"
- **같은 날짜 다중 병원**: 같은 날짜에 여러 병원에서 검사한 경우 순번 표시 (1, 2, ...)

### 2.4 시각화 및 알림
- **추세선 그래프**: `cPL`이나 `BUN/Creatinine` 같은 주요 항목은 클릭 시 시계열 꺾은선 그래프를 모달로 띄워준다.
- **이상 수치 하이라이트**: `High`/`Low` 상태인 셀은 배경색을 붉은색/파란색으로 칠해 직관적으로 보이게 한다.

### 2.5 장비별 참고치 관리 (Multi-Equipment Reference Ranges)
**핵심**: 같은 검사 항목이라도 장비마다 참고치가 다르므로, 각 결과마다 독립적인 참고치를 저장하고 표시해야 한다.

**장비별 참고치 차이 예시**:
- Hitachi 장비 Creatinine 참고치: 0~10 mg/dL
- IDEXX 장비 Creatinine 참고치: 0~<9 mg/dL (9 미만)
- Fuji 장비 Creatinine 참고치: 0.5~1.8 mg/dL

**피벗 테이블에서의 표시**:
- **항목명 헤더**: 각 항목명(예: Creatinine) 아래에 작은 회색 글씨로 "여러 참고치 적용됨" 표시
  ```
  Creatinine (크레아티닌)
  여러 참고치 적용됨
  ```
- **Tooltip(마우스 오버) 상세 정보**: 각 데이터 셀에 마우스를 올리면 풍선 팝업으로 표시
  ```
  [Creatinine 크레아티닌]
  검사일: 2025-01-15
  결과값: 1.2 mg/dL
  참고치: 0.5-1.8 (Hitachi)
  상태: Normal ✓
  ```
- **참고치 변경 경고**: 이전 검사와 참고치가 바뀐 경우 ⚠️ 아이콘 표시
  - Tooltip에 추가 메시지: "참고치 변경됨 (이전: 0-10, 현재: 0.5-1.8)"
  - 이유: 장비 교체, 검사 방법 변경 등을 사용자가 인지할 수 있도록

**시계열 그래프에서의 처리**:
- 참고치 범위가 검사마다 다를 수 있으므로, 그래프에 **여러 개의 참고치 밴드**를 표시
- 또는 가장 최근 검사의 참고치를 기본으로 표시하고, 참고치 변경 지점에 수직선 표시
- 범례에 "참고치: 검사마다 상이함" 명시

## 3. 화면별 상세 명세

### 3.0 일일 기록 페이지 (/daily-log) - v3.1 업데이트
**목표**: 반려동물의 일상 건강 상태를 빠르게 기록하고 확인

**UI 구성**:
- 📅 **날짜 헤더**:
  - 날짜 표시 (예: "2026년 1월 31일 금요일")
  - 캘린더 버튼 → 클릭 시 캘린더 팝오버
  - 이전/다음 날짜 이동 버튼
  - 📋 클립보드 내보내기 버튼 (v3.1 추가)
  - "오늘로 이동" 버튼 (과거 날짜 시 표시)

- 📊 **일일 통계 카드**:
  - 3열 그리드로 카테고리별 집계 표시
  - 식사: 총 g (횟수), 음수: 총 ml (횟수), 약: 횟수
  - 배변: 횟수, 배뇨: 횟수, 호흡수: 평균 회/분 (횟수)

- 📝 **타임라인**:
  - 시간순 정렬된 기록 목록
  - 각 항목: 시간 | 아이콘 | 양/내용 | 메모
  - 항목 클릭 → 상세 모달

- ✏️ **상세/수정 모달** (v3.1 추가):
  - 보기 모드: 상세 정보 표시
  - 수정 모드: 양, 약 이름, 메모 편집
  - 저장/취소 버튼

- ➕ **플로팅 추가 버튼**:
  - 우측 하단 고정
  - 클릭 시 카테고리 선택 시트

### 3.1 업로드 페이지 (/upload)
**목표**: 여러 파일을 한 번에 업로드하고 일괄 분석 시작

**UI 구성**:
- 📤 **파일 드롭존**: 점선 테두리의 드래그앤드롭 영역 (최대 10개 파일, 각 10MB 이하)
- 📋 **업로드된 파일 목록**:
  - 각 파일별 썸네일, 파일명, 크기 표시
  - ❌ 개별 삭제 버튼
- 🔍 **메타데이터 미리보기**: 첫 번째 파일에서 추출한 검사일자/병원명 표시
- ▶️ **[일괄 분석 시작]** 버튼: 모든 파일을 GPT-4o에 전송

### 3.2 결과 확인 페이지 (/preview)
**목표**: OCR 추출 결과를 매핑 전에 먼저 확인하고 수정

**UI 구성**:
- 📊 **원본 데이터 테이블**:
  ```
  | 항목명(OCR)    | 결과값 | 단위  | 참고치(Min-Max) | 출처 파일      |
  |---------------|-------|------|----------------|---------------|
  | Creatine      | 1.2   | mg/dL| 0.5-1.8        | chemistry.pdf |
  | WBC           | 8.5   | 10^3 | 5.0-16.0       | cbc.jpg       |
  ```
- ✏️ **인라인 수정**: 각 셀을 클릭하여 즉시 수정 가능
- ➡️ **[다음: AI 매칭 시작]** 버튼

### 3.3 매핑 확인 페이지 (/staging)
**목표**: AI가 제안한 매핑을 검수하고 불일치 항목 해결

**UI 구성**:
- 🎯 **매칭 결과 테이블**:
  ```
  | OCR 항목명 | AI 제안 표준 항목    | 신뢰도 | 결과값 | 상태      | 액션          |
  |-----------|-------------------|--------|-------|----------|--------------|
  | Creatine  | Creatinine (크레아티닌) | 🟢 95% | 1.2   | Normal   | [승인] [수정] |
  | vLIP      | (매칭 실패)          | 🔴 N/A | 450   | Unknown  | [선택▼] [신규+] |
  | WBC       | White Blood Cell  | 🟢 100%| 8.5   | Normal   | [승인]       |
  ```
- 🔴 **불일치 항목 필터**: 신뢰도 낮은 항목만 보기
- 📝 **드롭다운 선택기**: 표준 항목 수동 선택 (카테고리별 그룹화)
- ➕ **신규 항목 생성 모달**:
  - 표준 항목명 (영문)
  - 한글 표시명
  - 카테고리 (CBC/Chemistry/Special 등)
  - 기본 단위
- 💾 **[모두 저장]** 버튼: 확정 후 DB 저장

### 3.4 대시보드 페이지 (/dashboard)
**목표**: 저장된 모든 검사 결과를 피벗 테이블로 시각화

**UI 구성**: (기존과 동일하되, 다중 문서에서 온 데이터가 하나의 날짜 열로 통합됨)

### 3.5 검사 기록 관리 페이지 (/records-management) - v3.1 추가
**목표**: 저장된 검사 기록 목록 조회, 삭제, 병합

**UI 구성**:
- 📋 **검사 기록 테이블**:
  ```
  | ☐ | 검사일     | 병원명              | 항목 수 | 생성일        |
  |---|-----------|--------------------| -------|--------------|
  | ☐ | 2025-12-08 | 타임즈동물의료센터    | 25     | 2025-12-09   |
  | ☐ | 2025-12-02 | 서동심장동물병원      | 18     | 2025-12-03   |
  ```
- ☑️ **체크박스 선택**: 최대 2개까지 선택 가능
- 🔀 **[병합]** 버튼: 2개 선택 시 활성화
- 🗑️ **[삭제]** 버튼: 1개 이상 선택 시 활성화

### 3.6 병합 다이얼로그 - v3.1 추가
**목표**: 두 검사 기록의 충돌을 해결하고 병합

**UI 구성**:
- 📊 **양측 비교 영역**:
  ```
  [Source 기록]              [Target 기록]
  2025-12-02                 2025-12-08
  서동심장동물병원             타임즈동물의료센터
  18개 항목                  25개 항목
  ```

- 📅 **날짜 충돌 해결** (날짜가 다른 경우):
  ```
  최종 검사일 선택:
  ○ 2025-12-02 (Source)
  ● 2025-12-08 (Target)
  ```

- 🏥 **병원 충돌 해결** (병원이 다른 경우):
  ```
  최종 병원 선택:
  [타임즈동물의료센터 ▼]
  ```

- ⚠️ **항목 값 충돌 해결**:
  ```
  Creatinine:
  ○ 1.2 mg/dL (Source)
  ● 1.5 mg/dL (Target)

  BUN:
  ● 25 mg/dL (Source)
  ○ 28 mg/dL (Target)
  ```

- 💾 **[병합 실행]** 버튼

### 3.7 표준항목 관리 페이지 (/standard-items) - v3.2 추가
**목표**: 표준 검사 항목과 별칭을 관리

**UI 구성**:
- 📊 **통계 카드**:
  - 전체 표준 항목 수
  - 등록된 별칭 수
  - 검사 유형 수
  - [마스터 데이터 동기화] 버튼

- 📑 **탭 메뉴**:
  - 표준 항목 탭
  - 별칭 탭

#### 표준 항목 탭
- 🔍 **검색 및 필터**:
  - 항목명/한글명 검색
  - 검사 유형 드롭다운 필터
  - 새로고침 버튼
  - [+ 새 항목 추가] 버튼

- 📋 **항목 테이블**:
  ```
  | 항목명     | 한글명      | 단위  | 검사 유형   | 장기 태그           | 작업 |
  |-----------|------------|------|-----------|-------------------|-----|
  | Creatinine | 크레아티닌  | mg/dL | Chemistry | 신장, 전해질        | ✏️  |
  | cPL        | 췌장특이효소 | μg/L  | Special   | 췌장, 염증          | ✏️  |
  ```

- ✏️ **편집 모달**:
  - 항목명 (영문)
  - 한글명
  - 단위
  - 검사 유형 (드롭다운: Vital, CBC, Chemistry, ...)
  - 장기 태그 (다중 선택 배지)

- ➕ **신규 항목 추가 모달**:
  - 항목명 (영문) *필수*
  - 한글명
  - 단위
  - 검사 유형
  - 장기 태그

#### 별칭 탭
- 📋 **별칭 테이블**:
  ```
  | 별칭       | 표준 항목   | 장비 힌트  |
  |-----------|-----------|----------|
  | cHCO3(P)  | cHCO3     | ABL80F   |
  | Cre       | Creatinine | -        |
  | CREA      | Creatinine | IDEXX    |
  ```

---

### 3.8 대시보드 View 옵션 - v3.2 추가
**목표**: 피벗 테이블의 항목 정렬 방식을 선택

**UI 구성**:
- 🔀 **정렬 방식 선택 드롭다운**:
  - 검사유형별 (by_exam_type) - 기본값
  - 장기별 (by_organ)
  - 임상 우선순위별 (by_clinical_priority)
  - 검사 패널별 (by_panel)

- 🏷️ **장기 필터** (장기별 정렬 선택 시):
  - 전체
  - 기본신체, 혈액, 간, 신장, 췌장, 심장, 전해질, 산염기, ...

- 📋 **패널 필터** (패널별 정렬 선택 시):
  - 전체
  - 기본 혈액검사 (Basic)
  - 마취 전 검사 (Pre-anesthetic)
  - 노령견 종합 (Senior)
  - 췌장염 집중 (Pancreatitis)
  - 응고 검사 (Coagulation)
  - 응급/중환자 (Emergency)
  - 심장 검사 (Cardiac)
  - 신장 집중 (Kidney)

- 🏷️ **활성 필터 배지**: 선택된 장기/패널 표시 및 X 버튼으로 초기화

**정렬 로직**:
- **검사유형별**: Vital → CBC → Chemistry → Special → Blood Gas → Coagulation → 뇨검사 → 안과검사 → Echo
- **장기별**: 해당 장기의 organ_tags를 가진 항목만 그룹화
- **패널별**: 미리 정의된 검사 패널에 포함된 항목만 표시

---

## 4. UI 레퍼런스
- 미모의 기존 PDF 자료[Source 259]와 동일한 레이아웃을 웹으로 구현하되, 모바일에서도 볼 수 있도록 반응형 테이블(가로 스크롤 허용)로 제작한다.
- **다중 파일 업로드**: Dropzone.js 또는 react-dropzone 라이브러리 활용
- **매칭 신뢰도 시각화**: 프로그레스바 또는 색상 코드(녹색/노란색/빨간색)로 직관적 표시
